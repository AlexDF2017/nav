#!/usr/bin/perl -w
# Leter gjennom nettel-tabellen og finner nye
# eiere/org som har dukket opp. Disse legges til
# i org-tabellen i trapdetect-databasen, uten å 
# klusse opp med id'ene på de som ligger der fra før.
#
# John Magne Bredal 26-07-01
##################################################

use strict;
use DBI;

# Kobler til databasen
my $dbh = DBI->connect("trapdetect","nett","stotte","mysql");
my $hent_org = $dbh->prepare("select * from org");
$hent_org->execute;

# Legger alle org i en hash
my %org;
while (my @res = $hent_org->fetchrow_array) {
    $org{$res[1]}++;
}

# Henter alle org som finnes i nettel, her heter det eier
# Hvis de ikke finnes i org fra før, legges de inn der.
my $hent_eier = $dbh->prepare("select eier from manage.nettel group by eier");
$hent_eier->execute;
while (my @res = $hent_eier->fetchrow_array) {
    my $eier = $res[0];
    print "Sjekker om $eier finnes fra før...";
    unless ($org{$eier}) {
	print "nei - legger inn\n";
	my $sporring = "insert into org (navn) values ($eier)\n";
	print "$sporring\n";
	my $ok = $dbh->do($sporring);
	unless ($ok) {
	    print "En feil skjedde under innlegging i databasen...\n";
	}
    } else {
	print "ja\n";
    }
}

$dbh->disconnect;

