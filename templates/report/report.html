{% extends "report/base.html" %}

{% load report %}

{% block content %}

<div id="advToggle">
  <a>
    {% if adv %}
      Close Advanced Options
    {% else %}
      Advanced Options
    {% endif %}
  </a>
</div>

<div id="advblock" {% if not adv %}style="display: none;"{% endif %}>
  <h3>Advanced Search</h3>

  <div id="advforms" class="float-left">
    <form action="" method="get">
      <input id="adv" type="hidden" name="adv" value="1"/>

      {% comment %}
        Wouldn't it be nice if we used Django model- and
        form objects for this instead? Just sayin'...
      {% endcomment %}

      <table class="vertitable">
        {% if report.form %}
          {% for a in report.form %}
            {% with a_raw=a.raw counter=forloop.counter0 %}

              <tr>
                <th><label for="adv{{ counter }}">{{ a.title }}</label></th>

                <td>
                  {# TODO: Test if the if-statement works correctly (i.e. not "a_raw"). #}
                  <input
                    type="checkbox"
                    name="not_{{ a_raw }}"
                    id="not_adv{{ counter }}"
                    {% if a_raw in neg %}
                      checked
                    {% endif %}>
                </td>

                <td><label for="not_adv{{ counter }}">not</label></td>

                <td>
                  <select name="op_{{ a_raw }}">
                    {% for element in operatorlist %}

                      <option
                        value="{{ element }}"
                        {% if element in descriptions %}
                          title="{{ descriptions|get_item:element }}"
                        {% endif %}
                        {% ifequal element operator|get_item:a_raw|default:"" %}
                          selected
                        {% endifequal %}>
                        {{ operators|get_item:element }}
                      </option>

                    {% endfor %}
                  </select>
                </td>

                <td>
                  <input
                    type="text"
                    name="{{ a_raw }}"
                    id="adv{{ counter }}"
                    value="{{ contents|get_item:a_raw|default:"" }}">
                </td>
              </tr>

            {% endwith %}
          {% endfor %}
        {% endif %}

        <tr>
          <th></th>
          <td colspan="4">
            <button type="submit">Search</button>
          </td>
        </tr>

      </table>

      <h3>CSV Export</h3>
      <label for="export">Delimiter: </label>
      <select name="export">
        {% for delim in delimiters %}
          <option value="{{ delim }}">{{ delim }}</option>
        {% endfor %}
      </select>
      <button type="submit" name="exportcsv" value="1">Export</button>
    </form>
  </div>

  <div class="float-left">
    <div class="infobox">
      <h4>Operator usage</h4>

      <ul>
        <li>= - "equals", enter null for empty string</li>
        <li>~ - case insensitive search, use * as wildcard</li>
        <li>[:] - "between", takes two colon-separated arguments</li>
        <li>(,,) - "is one of", takes a comma-separated list of any size as argument.</li>
      </ul>

      <p>&lt;, &gt;, &lt;= and &gt;= needs no explanation.</p>
      <p>All these operators may be negated by clicking the "not" checkbox.</p>
    </div>
  </div>

</div> {# advblock #}

{% if report %}

  <table class="listtable, reporttable float-clear">

    <caption>
      {% if report.navigator.previous %}
        <span class="previous">
          <a title="previous page" href="?{{ report.navigator.previous }}">&lt;&lt;</a>
        </span>
      {% endif %}

      {{ report.title }}

      {% if report.navigator.next %}
        <span class="next">
          <a title="next page" href="?{{ report.navigator.next }}">&gt;&gt;</a>
        </span>
      {% endif %}

      <br>
      <span class="subtitle">{{ report.navigator.view }}</span>
    </caption>

    {% if report.table.header.cells %}
      <thead>
        <tr>
          {% for cell in report.table.header.cells %}
            <th>
            {% if cell.uri %}
              <a class="navbar" href="{{ cell.uri }}" title="{{ cell.explanation }}">{{ cell.text }}</a>
            {% else %}
              <a class="navbar" title="{{ cell.explanation }}">{{ cell.text }}</a>
            {% endif %}
            </th>
          {% endfor %}
        </tr>
      </thead>
    {% endif %}

    <tfoot>
      {% if report.table.footer.cells %}
        <tr class="tablesum">
          {% for cell in report.table.footer.cells %}
            <th>{{ cell.sum }}</th>
          {% endfor %}
        </tr>
      {% endif %}

      <tr>
        <th>
          {% if report.navigator.previous %}
            <span class="previous">
              <a title="previous page" href="?{{ report.navigator.previous }}">&lt;&lt;</a>
            </span>
          {% endif %}

          <span>{{ report.navigator.view }}</span>

          {% if report.navigator.next %}
            <span class="next">
              <a title="next page" href="?{{ report.navigator.next }}">&gt;&gt;</a>
            </span>
          {% endif %}
        </th>
      </tr>
    </tfoot>

    <tbody>
    {% if report.table.rows %}

      {% for row in report.table.rows %}
        <tr class="{% cycle 'oddrow' 'evenrow' %}">

          {% for cell in row.cells %}
            <td class="{% cycle 'oddcell' 'evencell' %}">

              {% if cell.uri %}
                <a href="{{ cell.uri }}">{{ cell.text }}</a>
              {% else %}
                {{ cell.text }}
              {% endif %}

            </td>
          {% endfor %}

        </tr>
      {% endfor %}

    {% else %}
      <tr><td></td></tr>
    {% endif %}
    </tbody>
  </table>

  <p>Result generated {{ result_time }}</p>

{% else %}
  <p class="error">No results found!</p>
{% endif %}

<script>
  $('#advToggle').click(function() {
    $('#advblock').toggle();
    var old_text = $(this).html();
    var new_text;
    if (old_text === '<a>Advanced Options</a>') {
      new_text = '<a>Close Advanced Options</a>';
    }
    else {
      new_text = '<a>Advanced Options</a>';
    }
    $(this).html(new_text);
  });
</script>
{% endblock content %}
