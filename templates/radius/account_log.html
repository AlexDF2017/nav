{% extends "radius/base.html" %}
{% load crispy_forms_tags %}

{% load radius %}

{% block content %}


  <div class="row">
    <div class="small-12 column">
      <a href="javascript:void(0);" class="button small secondary" data-reveal-id="account-log-hints">Search hints</a>
    </div>
  </div>

  <div id="forms">
    {% crispy form %}
  </div>

  {% if form.is_bound %}

    {% if result %}

    <div id="details_modal" class="reveal-modal"></div>

    <table id="resulttable" class="listtable full-width">
        <thead data-nosort='[5, 6]'>
          <tr>
            <th class="header">Username</th>
            <th class="header">Framed IP Address</th>
            <th class="header">NAS IP Address</th>
            <th class="header">Session start</th>
            <th class="header">Session stop</th>
            <th>Duration</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          {% for row in result %}
            <tr>
              <td class="link" data-filter="{{ row.username }}">{{ row.username }}</td>
              <td class="link" data-filter="{{ row.framedipaddress }}">{{ row.framedipaddress|default:"" }}</td>
              <td class="link" data-filter="{{ row.nasipaddress }}">{{ row.nasipaddress|default:"" }}</td>
              <td>{{ row.acctstarttime }}</td>
              <td>{{ row.acctstoptime }}</td>
              <td>{{ row.acctsessiontime|time_from_seconds }}</td>
              <td>
                <a href="acctdetail?acctuniqueid={{ row.radacctid }}"
                   data-reveal-id="details_modal" data-reveal-ajax="true"
                   title="View all available information on this session">
                  Details
                   </a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7">No results found</td>
            </tr>
          {% endfor %}
        </tbody>
    </table>

    <p>
    <table class="vertitable">
      <caption>Search summary</caption>
      <tr>
        <th>Total online time:</th>
        <td>{{ total_time|time_from_seconds }}</td>
      </tr>
      <tr>
        <th>Total data sent:</th>
        <td>{{ total_sent|filesizeformat }}</td>
      </tr>
      <tr>
        <th>Total received data:</th>
        <td>{{ total_received|filesizeformat }}</td>
      </tr>
      <tr>
        <th>Total traffic:</th>
        <td>{{ total_sent|add:total_received|filesizeformat }}</td>
      </tr>
    </table>
    </p>

    {% else %}
      <p class="alert-box">No results</p>
    {% endif %}

  {% endif %}

  {% block radius-helper %}
  <div id="account-log-hints" class="reveal-modal">
    <h5>Radius accounting search hints and information</h5>
    <ul>
      <li>
        When choosing timestamp as time filter, the slack is the number of
        minutes relative to the timestamp that will be used as interval. A
        timestamp of 2011-03-16 08:57|2 will search between 2011-03-16 08:55
        and 2011-03-16 08:59
      </li>
      <li>Username search allows wildcard searching, e.g. you can search for
        &quot;dat3*&quot;. Please note that the more letters of the
        username you include, the faster the search will be. A search for
        &quot;*&quot;, for example, will really test your
        patience.
      </li>

      <li>You can search for switch port on any particular switch by typing
        the switch hostname/ip address followed by a colon and the name
        of the switch port. Eg. switch.domain.com:FastEther0/2
      <li>In the search results, you will probably notice some things that
        might seem a bit weird at first:

        <ul>
          <li class="sub">
            You will see that some search results do not contain a timestamp in
            the Stop field. This occurs when 1) the session is still active,
            or 2) no explicit Stop message has been received by freeradius.
            You will have to check the Duration field to see which one it is.
          </li>

          <li class="sub">
            Sometimes the displayed session duration does not equal the
            difference
            between stop and start time. This occurs if the registered start
            time
            was actually not an explicit Start message, but the first sign of
            life
            (an Alive message) we got for this session. The Stop message
            always,
            as far as I know, contain the length of the session, and so when we
            have a Stop message this session length is being used during a
            search
            for a specific time interval.
          </li>
        </ul>
      </li>
      <li>Please notice that we only know the amount of data transferred for
        sessions where an explicit Stop message has been received. All transfer
        statistics should therefore be taken with a rather big scoop of salt,
        since the numbers don't include currently active sessions and since we
        have no way of making sure at which point in the session the transfers
        took place.
      </li>
      <li>Search type IP-range takes input in CIDR form, example:
        169.254.0.0/16
      </li>

    </ul>
  </div>
  {% endblock radius-helper %}
{% endblock content %}
