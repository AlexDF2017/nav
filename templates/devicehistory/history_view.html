{% extends "devicehistory/base.html" %}

{% block tabcontent %}
    <a href="{% url devicehistory-search %}" class="button small">New search</a>

    <div class="resultfilter">
        <form action="{% url devicehistory-view %}" method="get">
            {% for type, elements in selection.items %}
                {% for id in elements %}
                    <input type="hidden" name="{{ type }}" value="{{ id }}" />
                {% endfor %}
            {% endfor %}
            <table class="vertitable">
                {% include "devicehistory/history_view_filter.html" %}
                <tr>
                    <th></th>
                    <td><button type="submit">Filter</button></td>
                </tr>
            </table>
        </form>
    </div>

    <div class="searchparams">
    <h2>Search terms</h2>
    {% for type, elements in search_description.items %}
        <h3>{{ type|capfirst }}</h3>
        <ul>
        {% for id in elements %}
            <li>{{ id }}</li>
        {% endfor %}
        </ul>
    {% endfor %}
    </div>
    <div style="clear:both;"></div>

    {% include "devicehistory/paginator.html" %}

    {% for group_name, group in history.grouped_history.items %}
    <table class="listtable reporttable">
        <caption>
            {{ group_name }}<br />
            <span class="subtitle">{{ group|length }} items.</span>
        </caption>

        <thead>
            <tr>
                <th>Location</th>
                <th>Room</th>
                <th>Netbox</th>
                {# <th>Module</th> #}
                <th>Serial</th>
                <th>Start time</th>
                <th>End time</th>
                <th>Event type</th>
                <th>Alert type</th>
                <th>Message</th>
            </tr>
        </thead>

        <tfoot>
            <tr>
                <th colspan="10">
                    {{ group|length }} items.
                </th>
            </tr>
        </tfoot>

        <tbody>
        {% for h in group %}
            <tr class="{% cycle 'oddrow' 'evenrow' %}">
                <td>{{ h.netbox.room.location.id }}</td>
                <td>{{ h.netbox.room.id }}</td>
                <td>{{ h.netbox.sysname }}</td>
                {# <td>{{ h.module_name }}</td> #}
                <td>{{ h.device.serial|default_if_none:"" }}</td>
                <td>{{ h.start_time }}</td>
                <td>
                    {% if h.is_open %}
                    Unresolved
                    {% else %}
                    {{ h.end_time }}
                    {% endif %}
                </td>
                <td>{{ h.event_type.id }}</td>
                <td>{{ h.alert_type.name }}</td>
                <td>
                {% if h.extra_messages %}
                    <ul>
                    {% for state,m in h.extra_messages.items %}
                        <li class="sms_message" id="sms_{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                            <span>{{ m.sms }}</span>
                            <ul class="email_message" id="email_{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                                <li>{{ m.email|linebreaks }}</li>
                            </ul>
                        </li>
                    {% endfor %}
                    </ul>
                {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endfor %}

    {% include "devicehistory/paginator.html" %}

{% endblock %}
