#!/usr/bin/env bash

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
localstatedir=@localstatedir@
sysconfdir=@sysconfdir@
libdir=@libdir@
javalibdir=@javalibdir@

NAV_CONF="${sysconfdir}/nav.conf"

if test -z "$JAVA_HOME"; then 
    JAVA_HOME=`awk -F= '/JAVA_HOME/ && $1!~/#.*/{gsub("[\t ]", "", $2); print $2}' $NAV_CONF`
fi

if test -z "$JAVA_HOME"; then
    JAVA=`which java`
else
    JAVA="$JAVA_HOME/bin/java"
fi

if ! test -x "$JAVA"; then
    echo "Could not find a suitable Java environment." >&2
    echo "Maybe you should set the JAVA_HOME variable?" >&2
    exit 1
fi

CUR_DIR=${javalibdir}/networkDiscovery
LOG_DIR="${localstatedir}/log/networkDiscovery"
OUTLOG=${LOG_DIR}/networkDiscovery-$1.html
ERRLOG=${LOG_DIR}/networkDiscovery-stderr.log
JVM_OPTS="-Xmx268435456 -Djava.ext.dirs=${javalibdir}"

# If error log exists and has content, we rename it before creating a
# new one
if test -s ${ERRLOG}; then
    newname="${ERRLOG}.`date +'%Y-%m-%d-%H%M'`.log"
    mv ${ERRLOG} ${newname}
fi

cd $CUR_DIR
# Run program
$JAVA $JVM_OPTS -jar networkDiscovery.jar $* > ${OUTLOG} 2> ${ERRLOG}
