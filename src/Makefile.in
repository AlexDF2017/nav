##
## Makefile for NAV's Java subsystems
## 
SHELL = @SHELL@
prefix = @prefix@
exec_prefix = @exec_prefix@
sysconfdir = @sysconfdir@
initdir = @initdir@
bindir = @bindir@
libdir = @libdir@
javalibdir = @javalibdir@
localstatedir = @localstatedir@
webroot = @webroot@
tooldir = @tooldir@

top_srcdir = @top_srcdir@

INSTALLARGS = -DDESTDIR=$(DESTDIR)

subdirs = \
	Util \
	ConfigParser \
	Database \
	Event \
	eventEngine \
	getBoksMacs \
	getDeviceData \
	networkDiscovery \
	Logger \
	NetboxInfo \
	SimpleSnmp \
	vlanPlot \
	webapps/navAdmin \
	webapps/vPServer

# We build our own classpath, to resolve interdependencies between the java modules.
CLASSPATH = $(shell for x in $(subdirs); do echo -n "$$PWD/$${x}/build:"; done ; echo -n $$CLASSPATH)
INSTALL_TARGETS = $(patsubst %,%_inst,$(subdirs))
QUICK_TARGETS = $(patsubst %,%_q,$(subdirs))

ANT = @ANT@

# Make sure we export make variables to the environment
export
.PHONY = all install clean distclean debug .lastbuild $(INSTALL_TARGETS) $(QUICK_TARGETS)

all: $(subdirs)

$(subdirs): .lastbuild
	@echo "Building $@ ..."
	(cd $@ && $(ANT) $(BUILDARGS)) && touch $@

# Describe interdependencies here:
ConfigParser:
Database: Logger
Event: Database Logger
eventEngine: ConfigParser Database Event Logger
getBoksMacs: ConfigParser Database Event Logger NetboxInfo SimpleSnmp
getDeviceData: ConfigParser Database Event Logger NetboxInfo SimpleSnmp
networkDiscovery: ConfigParser Database Event Logger NetboxInfo
Logger: ConfigParser Util
NetboxInfo: Database Event Logger
SimpleSnmp: Database Logger
Util:
webapps/navAdmin: ConfigParser Database Event Logger

.lastbuild:
# Do absolutely nothing, just let ANT decide whether a rebuild is necessary

install:
	@for dir in $(subdirs); do \
	  echo "Installing $$dir ..."; \
	  (cd $$dir && $(ANT) install $(INSTALLARGS)) || exit 1; \
	done

clean:
	rm -f *~ .lastbuild
	@for dir in $(subdirs); do \
	  echo "Entering $$dir ..."; \
	  (cd $$dir && $(ANT) $@) || exit 1; \
	done

distclean:
	@echo Target distclean is not supported in the java projects, but should be...
	rm -f Makefile build.properties

# Debug target just prints some debug information from the Makefile
debug:
	@echo Classpath:
	@echo $$CLASSPATH
	@echo 
	@echo INSTALL_TARGETS:
	@echo $(INSTALL_TARGETS)

$(INSTALL_TARGETS):
	@dir="$(patsubst %_inst,%,$@)";  \
	echo "Installing $$dir ..."; \
	cd $$dir && $(ANT) install $(INSTALLARGS)

$(QUICK_TARGETS):
	@realtarget="$(patsubst %_q,%,$@)";                            \
	echo "Building $$realtarget ..." ;                             \
	(cd $$realtarget && $(ANT) $(BUILDARGS)) && touch $$realtarget
