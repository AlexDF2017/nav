##
## Top-level Makefile for NAV
##
SHELL = @SHELL@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
perllibdir = @perllibdir@
pythonlibdir = @pythonlibdir@
javalibdir = @javalibdir@
sysconfdir = @sysconfdir@
webroot = @webroot@
initdir = @initdir@
localstatedir = @localstatedir@
tooldir = @tooldir@

INSTALL = @INSTALL@
nav_user = @nav_user@
top_srcdir = @top_srcdir@

NAME=nav
VERSION=$(shell cat VERSION)
PACKAGE=$(NAME)-$(VERSION)

subdirs = src \
	subsystem/lib-perl \
	subsystem/lib-python \
	subsystem/alertEngine \
	subsystem/alertprofiles \
	subsystem/backup \
	subsystem/devBrowser \
	subsystem/deviceManagement \
	subsystem/editdb \
	subsystem/eMotd \
	subsystem/machinetracker \
	subsystem/report \
	subsystem/smsd \
	subsystem/startstop \
	subsystem/statemon \
	subsystem/statTools \
	subsystem/status \
	subsystem/thresholdMon \
	subsystem/webFront

# Make sure we export make variables to the environment
export
.PHONY: all install clean distclean installdirs dist

all:
	@for dir in ${subdirs}; do \
	  $(MAKE) -C $$dir $@ || exit 1; \
	done
	@echo Done

install: installdirs
	@for dir in ${subdirs}; do \
	  $(MAKE) -C $$dir $@ || exit 1; \
	done
	tools/htpython.sh $(DESTDIR)$(webroot) $(webroot)
	@echo Done

installdirs:
	$(INSTALL) -v -m 0755 -d $(DESTDIR)$(prefix)
	$(INSTALL) -v -m 0755 -d $(DESTDIR)$(exec_prefix)
	$(INSTALL) -v -m 0775 -d $(DESTDIR)$(sysconfdir)
	$(INSTALL) -v -m 0755 -d $(DESTDIR)$(bindir)
	$(INSTALL) -v -m 0755 -d $(DESTDIR)$(libdir)
	$(INSTALL) -v -m 0755 -d $(DESTDIR)$(javalibdir)
	$(INSTALL) -v -m 0755 -d $(DESTDIR)$(perllibdir)
	$(INSTALL) -v -m 0755 -d $(DESTDIR)$(pythonlibdir)
	$(INSTALL) -v -m 0755 -d $(DESTDIR)$(webroot)
	$(INSTALL) -v -m 0775 -d $(DESTDIR)$(tooldir)
	$(INSTALL) -v -m 2775 -d $(DESTDIR)$(localstatedir)
	$(INSTALL) -v -m 2775 -d $(DESTDIR)$(localstatedir)/log
	$(INSTALL) -v -m 2775 -d $(DESTDIR)$(localstatedir)/run
	$(INSTALL) -v -m 2775 -d $(DESTDIR)$(localstatedir)/rrd

clean:
	rm -f *~ 
	@for dir in ${subdirs}; do \
	  $(MAKE) -C $$dir $@ || exit 1; \
	done

distclean: clean
	rm -f config.status config.cache config.log Makefile
	@for dir in ${subdirs}; do \
	  $(MAKE) -C $$dir $@ || exit 1; \
	done

# dist: distclean
dist:
	@echo Creating source tarball...
	@SRCDIR=`pwd`;                                  \
	TARBALL=$(PACKAGE).tar.gz;                      \
	/bin/rm -f /tmp/$(PACKAGE) $$TARBALL;           \
	ln -s $$SRCDIR /tmp/$(PACKAGE);                 \
	cd /tmp;                                        \
        tar -czf $$TARBALL --exclude .svn $(PACKAGE)/*; \
	/bin/rm -f /tmp/$(PACKAGE);                     \
	/bin/mv /tmp/$$TARBALL $$SRCDIR;                \
	echo Placed as $$TARBALL
