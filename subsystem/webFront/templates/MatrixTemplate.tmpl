#endoding=UTF-8
#extends nav.web.templates.MainTemplate

<h1>Tabular view of $network</h1>
<p>This table shows how the subnets are utilized.</p>

<table style="border: 1px solid black; font-size: 0.8em;">
<tr>
<td>&nbsp;</td>
#block headings
#for $heading in $column_heading
	<th>$heading</th>
#end for
#end block

#block matrix
</tr>

#def $extract_matrix($subnet,$depth)
	#set $keys = $sort_nets($subnet.keys())
	#for $net in $keys
		#if $matrix_nets.has_key($net)
			#set $diff = $net_diff($net,$lastnet)
			#if $len($diff) > 1
				#if $len($diff) > $max_diff_before_dots
					#for i in range(0,3)
						<tr><td>.</td></tr>
					#end for
				#else
					#for $ip in $diff
						<tr>
						<td>$netlink($ip,False)</td>
						</tr>
					#end for
				#end if
				#return
			#end if

			#if $has_too_small_nets($net)
				#set $cols= 2**$bits_in_matrix
				<tr>
				<td colspan="$cols" style="text-align:center;background-color:$load(0,'large')">Many small subnets</td>
				</tr>
			#else
				<tr>
				#for $ip in $sort_nets($matrix_nets[$net])
					<td>$netlink($net)</td>
					<td colspan="$colspan(net)" style="background-color:$load($netype($net),$utilization($net).percent); text-align:center;">
					$ip.prefixlen() $utilization($ip).percent
					</td>
				#end for
				</tr>
			#end if
		#else
			<tr>
			<td>
			#for $i in range(0,depth)
				&nbsp;#slurp
			#end for
			$netlink($net,False)
			</td>
			</tr>
			$extract_matrix($net,depth+1)
		#end if
	#end for
#end def

#def $makeMatrixRow($net)
#end def
#end block
</table>

#def $netlink($ip,$removeLastNetOctets=True)
	#if $removeLastNetOctets
		$nip = $extractNetOctets($ip)
		<a href="/report/prefix?host(netaddr)=$nip.%&op_host(netaddr)=like">$nip</a>
	#else
		<a href="/report/prefix?prefixid=$getPrefix($ip)">#str(ip.net())</a>
	#end if
#end def

#def $matrixlink($ip)
	<a href="/report/prefix?prefixid=$getPrefix($ip)">$getLastNetOctets($ip)</a>

#def $colspan($ip)
	2**($end_net.prefixlen()-$ip.prefixlen())
#end def
			
