SHELL = @SHELL@
INSTALL = @INSTALL@
CHEETAH = @CHEETAH@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
sysconfdir = @sysconfdir@

pythonlibdir = @pythonlibdir@
webroot = @webroot@
djangotmpldir = ${libdir}/templates

top_srcdir = @top_srcdir@

DJANGO_TEMPLATES_SRC = $(wildcard templates/*/*)
DJANGO_TEMPLATES = $(DJANGO_TEMPLATES_SRC:templates/%=%)

config = contact-information.txt  nav-links.conf  welcome-anonymous.txt external-links.txt webfront.conf welcome-registered.txt

.PHONY: all install install-lib install-bin install-web install-images clean distclean install-conf

all: config/webfront.conf
	$(MAKE) -C lib/nav/web/templates $@

config/webfront.conf: config/webfront.conf.source
	$(top_srcdir)/tools/expand.pl config/webfront.conf.source > config/webfront.conf

install: install-lib install-bin install-web install-conf
	$(MAKE) -C lib/nav/web/templates $@

install-lib:
	@cd lib; \
	for file in nav/web/*.py; do \
	  $(INSTALL) -v -D -m 644 $$file $(DESTDIR)/$(pythonlibdir)/$$file || exit 1; \
	done
	for file in $(DJANGO_TEMPLATES); do \
	  $(INSTALL) -v -D -m 644 templates/$$file $(DESTDIR)$(djangotmpldir)/$$file || exit 1; \
	done

install-bin:
	@cd bin; \
	for file in *.py; do \
	  $(INSTALL) -v -D -m 755 $$file $(DESTDIR)$(bindir)/$$file || exit 1; \
	done

install-web: install-images
	@cd src; \
	installable=`find . -name '*.py' -or -name '.htaccess' -or -name '*.html' -or -name '*.css' -or -name '*.js'`; \
	for file in $$installable; do \
	  $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(webroot)/$$file || exit 1; \
	done

install-images:
	@cd graphics; \
	installable=`find . -name '.htaccess' -or -name '*.png' -or -name '*.gif' -or -name '*.jpg'`; \
	for file in $$installable; do \
	  $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(webroot)/$$file || exit 1; \
	done

install-conf:
	cd config;                                             \
	for file in $(config); do                              \
	  target=$(DESTDIR)$(sysconfdir)/webfront/$$file;      \
	  if [ -f "$$target" ]; then                           \
	    echo Skipping installation of config file $$file;  \
	  else                                                 \
	    $(INSTALL) -v -D -m 644 $$file $$target;           \
	  fi                                                   \
	done

clean:
	@backups=`find lib bin src -name '*~'`; \
	rm -f $$backups
	rm -f *~
	$(MAKE) -C lib/nav/web/templates $@

distclean: clean
	rm -f Makefile
	$(MAKE) -C lib/nav/web/templates $@
