#! /usr/bin/env make
# -*- coding: UTF-8 -*-
#
# Copyright 2008 UNINETT AS
#
# This file is part of Network Administration Visualized (NAV)
#
# NAV is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# NAV is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with NAV; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# Authors: Stein Magnus Jodal <stein.magnus.jodal@uninett.no>
#

# Programs
SHELL = @SHELL@
INSTALL = @INSTALL@
CHEETAH = @CHEETAH@

# Paths
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
sysconfdir = @sysconfdir@
pythonlibdir = @pythonlibdir@
webroot = @webroot@
djangotmpldir = @djangotmpldir@
top_srcdir = @top_srcdir@

# Files
INITFILES =
BINS = navTemplate.py
LIBS = $(wildcard nav/web/*.py) nav/web/templates/__init__.py
CONFFILES_SRC = $(wildcard config/webfront/*.txt config/webfront/*.conf) config/webfront/webfront.conf
CONFFILES = $(CONFFILES_SRC:config/%=%)
TOOLS =
TEMPLATES_SRC = $(wildcard nav/web/templates/*.tmpl)
TEMPLATES = $(TEMPLATES_SRC:%.tmpl=%.py)
DJANGO_TEMPLATES_SRC = $(wildcard templates/*/*)
DJANGO_TEMPLATES = $(DJANGO_TEMPLATES_SRC:templates/%=%)

.PHONY: all lib bin conf web install install-lib install-bin install-conf install-web install-images clean distclean

all: lib bin conf web
lib: $(TEMPLATES)
bin:
conf: config/webfront/webfront.conf
web:

config/webfront/webfront.conf: config/webfront/webfront.conf.source
	$(top_srcdir)/tools/expand.pl $< > $@

$(TEMPLATES): %.py: %.tmpl
	$(CHEETAH) compile $<

install: install-lib install-bin install-conf install-web

install-lib: $(TEMPLATES)
	for file in $(LIBS) $(TEMPLATES); do $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(pythonlibdir)/$$file || exit 1; done
	for file in $(DJANGO_TEMPLATES); do $(INSTALL) -v -D -m 644 templates/$$file $(DESTDIR)$(djangotmpldir)/$$file || exit 1; done

install-bin:
	cd bin; for file in $(BINS); do $(INSTALL) -v -D -m 755 $$file $(DESTDIR)$(bindir)/$$file || exit 1; done
	for file in $(INITFILES); do $(INSTALL) -v -D -m 755 $$file $(DESTDIR)$(initdir)/$$file || exit 1; done

install-conf:
	@cd config; \
	for file in $(CONFFILES); do \
		target=$(DESTDIR)$(sysconfdir)/$$file; \
		if [ -f "$$target" ]; then \
			echo "Skipping installation of config file $$file"; \
		else \
			$(INSTALL) -v -D -m 644 $$file $$target || exit 1; \
		fi \
	done

install-web: install-media
	@cd src; \
	installable=`find . -name '*.py' -or -name '.htaccess' -or -name '*.html'`; \
	for file in $$installable; do \
	  $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(webroot)/$$file || exit 1; \
	done

install-media:
	@cd media; \
	installable=`find . -name '.htaccess' -or -name '*.png' -or -name '*.gif' -or -name '*.jpg' -or -name '*.css' -or -name '*.js'`; \
	for file in $$installable; do \
	  $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(webroot)/$$file || exit 1; \
	done

clean:
	find -name *.pyc -print0 | xargs -0 rm -f
	for file in $(TEMPLATES); do rm -f $$file; done

distclean: clean
	find -name \*~ -print0 | xargs -0 rm -f
	rm -f Makefile

