########################################
# TrapDetect - README
#
# Av John Magne Bredal
# 27-07-2000
########################################


--- HVA GJØR PROGRAMMET? ---

TrapDetect er et program som bruker input fra programmet snmptrapd (en
del av UCD-SNMP-pakken) til å finne bestemte traps som den skal
reagere på. Det består av selve hovedprogrammet, TrapDetect, og en
rekke filer som den leser fra og skriver til. Se ellers web-siden,
HJELP, for mer info.

--- KATEGORIER ---

For å få en noenlunde fornuftig programoppbygning var det nødvendig å
dele opp de ulike trap'ene i kategorier. Dette fordi det var store
forskjeller i måten man måtte behandle hver kategori på. Systemet er
ennå ikke perfekt, men slik det fungerer nå vil de fleste traps kunne
reageres på.

Kategori 1: 
Her kommer traps som ikke har noen tilstand. Dvs. de er hverken
sykmeldinger eller friskmeldinger, de er bare en melding om at noe har
skjedd. Et eksempel på slike traps er coldStart. Denne trap'en
forteller at enheten nettopp har foretatt en restart. Men siden
trap'en kommer etter at enheten har restartet gir det ingen mening å
gi en friskmelding på dette.

Kategori 2:
Under denne kategorien kommer traps som har tilstand, dvs. de er enten
syk- eller friskmeldinger, men sub-oid'ene har alltid samme
verdi. F.eks. en linkUp og en linkDown-trap vil gi samme informasjon
om hvilket interface det var som gikk ned og som kom opp.

Kategori 3:
Her kommer alle traps som har tilstand OG som gir ulike verdier på
suboid'er ved syk- og friskmelding. Disse trap'ene er vanskelig å
generalisere, så jeg har foreløpig bare gitt mulighet for å skrive
script til å reagere på disse trap'ene.


--- OID ---

En OID (Object IDentifier) er en unik identifikator som identifiserer
informasjonen i trap'en. For lettere å forstå hva som kommer inn fra
en trap, vil jeg definere to ulike OID'er: hovedOID og
subOID. HovedOID'en er den som identifiserer hvilken type trap det
er. En linkDown-trap er et eksempel på en type, en coldStart-trap er
et annet eksempel. En subOID identifiserer infoen som følger med i
trap'en. I en linkDown-trap vil det f.eks. alltid være med en
ifIndex-OID som identifiserer hvilket interface som gikk ned.


--- KONFIGURERING ---

Det er tre konfigurasjonsfiler som brukes:

TrapDetect.conf: liste over alle traps som programmet skal reagere på.

alarmList: liste over alarmer, og til hvem hver alarm skal sende
beskjed. 

serviceList: liste over enheter som er satt på service. NB! Denne kan
være ganske full ettersom programmet hiver enheter inn her dersom en
kat1 trap kommer inn.

Disse filene må editeres manuelt, med en REN teksteditor slik som vi,
emacs, pico eller lignende. Programmet søker på bestemte mønster i
disse filene, og en evt. forandring av disse vil føre til at
programmet ikke fungerer i det hele tatt. Spesielt gjelder dette
TrapDetect.conf.


NOTATER OM FILENE:

- TrapDetect.conf:
Inneholder alle OID'er som programmet reagerer på. Formatet står i
fila. Enhver OID må komme under en kategori. Se notat om
KATEGORIER. En "-" betegner avslutning av en hovedOID + alle
subOID'ene. Det kan komme flere subOID'er under hovedOID'en, men
avslutningen må være en "-". Script er valgfritt, men vil utføres hvis
det blir oppført. Script MÅ skrives til kat3 traps.

Hvis man vil sende flere alarmer pr. trap mottatt, er dette fullt
mulig ved å adskille alarmene med komma. Men man må IKKE ha mellomrom
av noe slag mellom alarmene, da skjer stygge ting (egentlig ikke, men
alarmene blir ikke sendt). Se eksempel i filen for å være helt sikker.

NB! Suboid'er har en tendens til å være noe utrygge. Med det mener jeg
at jeg ikke helt vet om det er noen standard på dem. De fleste kommer
med ekstra info på slutten av oid'en, noe jeg filtrerer vekk. Men på
hysteresealarm-traps kommer ikke denne ekstra infoen, noe jeg også må
ta hensyn til. Dette gjør at det er usikkert om det vil fungere med en
gang hvis man legger til nye subOID'er. Jeg skal etterhvert se om jeg
får fikset dette.

- alarmList:
Ikke mye å si her. Skriv opp nummeret på alarmen og adressen den skal
sendes til. Bør være rimelig sikker.

- serviceList
Også denne er rimelig grei. Skriv inn ip-adresse på enhet som vi ikke
vil behandle traps fra, et mellomrom og skriv dato vi skal begynne å
behandle traps igjen. Bruk formatet som står i fila, og det skal
fungere prikkfritt.


--- AUTOMATISERTE OPPGAVER ---

Logrotering traplog: 
traplog er hovedlog'en til programmet. Den logger alle output fra
snmptrapd og TrapDetect. Siden den kan bli stor, skiftes den ut hver
natt klokken 00:01:00 vha.  et skript som heter
trapdet/bin/skift. Log'en flyttes til traplogxxxxxx, der xxxxxx er
gårdagens dato, og ny hovedlogg lages.

Logrotering history:
history er filen som inneholder oversikt over sykmeldte enheter, og
når de evt. ble friskmeldt. Siden denne log'en også kan bli stor,
roteres den hver natt klokken 00:01:00 vha et skript som heter
/trapdet/bin/skift. Skriptet flytter history til historyxxxxxx, der
xxxxxx er gårdagens dato, og kopierer i tillegg alle eksisterende
sykmeldte enheter fra sick til den nye history. Dette fordi alle
friskmeldinger skal logges.

Backup:
Hver natt tas backup vha. et script som heter /trapdet/bin/backup. Det
lages ny katalog i /tmp/backup med navnformat TrapDetect'ddmmyy'. Alle
filene kopieres over til den katalogen.

Sending av delayed GSM:
Hver morgen klokken 06:00:00 sendes evt. mailer som ligger i filen
delayedMessages til sine nevnte mottakere. Til dette brukes scriptet
trapdet/bin/sendDelayedGSM. Dette fordi de som skal motta beskjed om
traps på sin GSM, skal få sin skjønnhets-søvn hvis mindre viktige
traps som har forekommet. :)

Fjerning av gif'er:
Ca. hver 3. time slettes alle unødvendige gif'er fra www/gif/. Se
hvorfor under "Hva er de forskjellige filene til?".

Sletting av gamle filer: 
Hver måned på den første dagen i måneden, kjøres scriptet
bin/skiftMnd. Dette scriptet sletter alle filer som er to måneder
gamle. Dette gjelder filer som ligger i log/, statistikk/log/ og
/tmp/backup/ og har seks tall i filnavnet. Derfor er det ingen god ide
å lage filer med filnavn med seks tall i som det er meningen skal være
der hele tiden. Scriptet kicker bare inn på filer der det midterste
tallet er det samme som måneden to måneder tilbake (puh). Dvs. i
september (09) slettes alle filer som ligger i de nevnte katalogene og
der filnavnet har seks tall i seg og det midterste er 07. Burde være
greit å unngå.

Sletting av innlegg i sick-fil: 
Hver kveld klokken 23:59 kjøres scriptet redigersick. Dette scriptet
fjerner alle innlegg i sick-fila som er mer enn 7 dager gamle. Dette slik
at sick-fila ikke tar vare på innlegg som det mest sannsynlig ikke kommer
friskmeldinger på (kan være tapt blant annet pga. at det er UDP som
brukes).


--- Hva er de forskjellige filene til? ---

- README:
Denne filen. Er til for din hygge og trivsel.

- TrapDetect:
Hovedprogrammet. Kjøres hver gang snmptrapd får inn en trap. Skrevet i
Perl.

- bin/
katalogen som inneholder alle eksekverbare filer. Alle skrevet i Perl.

- bin/backup
Oppretter ny katalog på /tmp/backup og kopierer alle filene herfra og
dit, en såkalt backup... :)

- bin/fjernMnd
Fjerner alle filer som er to måneder gammel. Kjøres på den første
dagen i en ny måned. Sikrer at ikke diskforbruket går i taket.

- bin/fjerngif
Fjerner alle gif'er som lages når man bruker web-siden. Dette fordi
jeg må lage en ny gif for hver gang du skal se et bilde, pga. at
Netscape cacher bildene, og dette gjør at antall bilder blir veeeeldig
stort etterhvert.

- bin/redigersick
Fjerner innlegg i sick-fila som er mer enn 7 dager gamle.

- bin/sendDelayedGSM
Sender alle meldingene som står i delayedMessages hver morgen

- bin/skift
Gjør en rekke skiftoperasjoner på info-filer slik som sick og
history. Kopierer og renamer filer, nullstiller dem, og that's
it. Gjøres fordi man da kan gå inn på bestemte datoer og se hva som
skjedde da, istedet for å ha alt i en eneste stor fil.

- command 
Inneholder bare den tekststrengen jeg kjører hver gang jeg skal starte
snmptrapd-programmet. Fint å bruke den hvis noen andre skulle prøve å
sette det i gang etter en strømfeil eller lignende. Hele programmet er
faktisk avhengig av det... :)

- config
Config-fila til snmptrapd-programmet. Må inneholde den ene linjen som
sier at det er TrapDetect som skal kjøres hver gang den tar i mot en
trap. Se ellers "man snmptrapd".

- delayedMessages
Denne fila er enten her, og da er den full av beskjeder og
mail-adresser, ellers så er den ikke her, og det skal være mellom
klokken 06.00 og 23.30. Brukes av TrapDetect for å kunne sende
forsinkede GSM-beskjeder.

- etc/
Katalogen som inneholder alle konfigurasjonefilene.

- etc/TrapDetect.conf
- etc/alarmList
- etc/serviceList
Se KONFIGURERING.

- etc/cron
Cronjobbene som kjøres. Hvis du vil forandre på tiden ting kjører
eller vil legge til/fjerne jobber, editer denne fila først, og så
kjører du "crontab cron". Simple as that!

- log/
Katalogen som inneholder alle loggene.

- log/backuplog
Datoer over når backup er tatt. Hvis det står ugne feilmeldinger der
tyder det dårlig.

- log/delaylog
Oversikt over sending av delayedGSMmessages.

- log/fjernMnd_log
Log over fjernMnd-scriptet.

- log/fjerngif_log
Antall filer som er slettet hver gang fjerngif-scriptet er kjørt.

- log/history
History er hendelsesergistret på web-siden. Denne filen er dagens fil,
og MÅ være "rw-rw-rw". Ikke helt bra, men dette er for redigering av
fila vha. php3. 

- log/historyxxxxxx
Tidligere historyfiler angitt ved dato.

- log/redigersick_log
Log over scriptet redigersick.

- log/skiftlog
Eksisterer. Skal ikke inneholde noe med mindre skift-scriptet tar helt
av.

- log/traplog
Dagens log.

- log/traplogxxxxxx
Tidligere dagers log.

- sick
Den eneste fila jeg trodde jeg trengte... Så feil kan man ta. Oversikt
over nåværende status/feilmeldinger. Samme som status nå-sida på
web. Må også være "rw-rw-rw", som igjen ikke er helt bra... samme
grunn som sist.

- statistikk/
Katalog som inneholder alle statistikk-filer (foreløpig bare
en). Morsom liten sak som jeg er ganske fornøyd med.

- statistikk/log/
Katalog som inneholder alle statistikk-filer for tidligere dager.

- statistikk/log/oiddag.datxxxxxx
Samme som filen nedenfor, bare at det er for en tidligere dato.

- statistikk/oiddag.dat
Oversikt over alle enheter som har sendt trap, hvilken hovedOID, og
hvor mange ganger. Tidsrom: et døgn.

- www/
Symlink til den kjære web-siden.
