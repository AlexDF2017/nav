SHELL = @SHELL@
INSTALL = @INSTALL@
CHEETAH = @CHEETAH@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
sysconfdir = @sysconfdir@

pythonlibdir = @pythonlibdir@
templatedir = ${pythonlibdir}/nav/web/templates
handlerdir = ${pythonlibdir}/nav/web
webroot = @webroot@
tooldir = @tooldir@

templates = ArnoldTemplate.py # lib/python/nav/web/templates/
handlerfiles = arnoldhandler.py # lib/python/nav/web/
webfiles = .htaccess # webroot/arnold/
binfiles = arnold.py autoenable.py start_arnold.py t1000.py
conffiles = arnold.conf nonblock.conf mailtemplates/README
tool = arnold.tool

.PHONY: all install install-lib install-web install-bin clean distclean

all: $(templates)

$(templates): %.py: %.tmpl
	$(CHEETAH) compile $<

install: install-bin install-lib install-web install-conf

install-bin:
	for file in $(binfiles); do \
	  $(INSTALL) -v -D -m 755 $$file $(DESTDIR)$(bindir)/$$file || exit 1; \
	done

install-conf:
	for file in $(conffiles); do \
	  target=$(DESTDIR)$(sysconfdir)/arnold/$$file; \
	  if [ -f "$$target" ]; then \
            echo Skipping installation of config file $$file; \
          else \
	    $(INSTALL) -v -D -m 644 config/$$file $$target || exit 1; \
	  fi; \
	done

install-lib: $(templates)
	for file in $(templates); do \
	  $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(templatedir)/$$file || exit 1; \
	done
	$(MAKE) -C lib $@

install-web:
	for file in $(webfiles); do \
	  $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(webroot)/arnold/$$file || exit 1; \
	done
	for file in $(handlerfiles); do \
	  $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(handlerdir)/$$file || exit 1; \
	done
	$(INSTALL) -D -v -m 644 $(tool) $(DESTDIR)$(tooldir)/$(tool)
	$(MAKE) -C images $@

clean:
	rm -f *~
	rm -f $(templates)

distclean: clean
	rm -f Makefile
