#! /usr/bin/env make
# Programs
INSTALL = @INSTALL@
CHEETAH = @CHEETAH@

# Paths
prefix = @prefix@
bindir = @bindir@
libdir = @libdir@
exec_prefix = @exec_prefix@
sysconfdir = @sysconfdir@
initdir = @initdir@
localstatedir = @localstatedir@
tooldir = @tooldir@
pythonlibdir = @pythonlibdir@
djangotmpldir = @djangotmpldir@
webroot = @webroot@

# Names
WEBNAME = alertprofiles

# Files
INITFILES =
BINS =
LIBS = $(wildcard nav/django/urls/alertprofiles.py nav/web/alertprofiles/*.py)
CONFFILES_SRC = $(wildcard config/*/*)
CONFFILES = $(CONFFILES_SRC:config/%=%)
TOOLS = alertprofiles.tool
TEMPLATESSRC = $(wildcard nav/web/templates/*.tmpl)
TEMPLATES = $(TEMPLATESSRC:%.tmpl=%.py)
DJANGO_TEMPLATES_SRC = $(wildcard templates/*/*)
DJANGO_TEMPLATES = $(DJANGO_TEMPLATES_SRC:templates/%=%)
MEDIA_SRC = $(wildcard media/*/*)
MEDIA = $(MEDIA_SRC:media/%=%)
IMAGES_SRC = $(wildcard images/*/*)
IMAGES = $(IMAGES_SRC:images/%=%)

.PHONY: all lib bin conf web install install-lib install-bin install-conf install-web uninstall clean distclean

all: lib bin conf web
lib: $(TEMPLATES)
bin:
conf:
web:

$(TEMPLATES): %.py: %.tmpl
	$(CHEETAH) compile $<

install: all install-lib install-bin install-conf install-web

install-lib: lib $(TEMPLATES)
	for file in $(LIBS) $(TEMPLATES); do $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(pythonlibdir)/$$file || exit 1; done
	for file in $(DJANGO_TEMPLATES); do $(INSTALL) -v -D -m 644 templates/$$file $(DESTDIR)$(djangotmpldir)/$$file || exit 1; done

install-bin: bin
	for file in $(BINS); do $(INSTALL) -v -D -m 755 $$file $(DESTDIR)$(bindir)/$$file || exit 1; done
	for file in $(INITFILES); do $(INSTALL) -v -D -m 755 $$file $(DESTDIR)$(initdir)/$$file	|| exit 1; done

install-conf: conf
	@for file in $(CONFFILES); do \
		target=$(DESTDIR)$(sysconfdir)/$$file; \
		if [ -f "$$target" ]; then \
			echo "Skipping installation of config file $$file"; \
		else \
			$(INSTALL) -v -D -m 644 config/$$file $$target || exit 1; \
		fi \
	done

install-web: web
	for file in $(TOOLS); do $(INSTALL) -v -D -m 644 $$file $(DESTDIR)$(tooldir)/$$file || exit 1; done
	$(INSTALL) -v -D -m 644 htaccess $(DESTDIR)$(webroot)/$(WEBNAME)/.htaccess
	for file in $(MEDIA); do $(INSTALL) -v -D -m 644 media/$$file $(DESTDIR)$(webroot)/$$file || exit 1; done
	for file in $(IMAGES); do $(INSTALL) -v -D -m 644 images/$$file $(DESTDIR)$(webroot)/images/$$file || exit 1; done

uninstall:
	for file in $(BINS); do rm -f $(DESTDIR)$(bindir)/$$file || exit 1; done
	for file in $(LIBS); do rm -f $(DESTDIR)$(pythonlibdir)/$$file || exit 1; done
	for file in $(DJANGO_TEMPLATES); do rm -rf $(DESTDIR)$(djangotmpldir)/$$file || exit 1; done
	for file in $(TOOLS); do rm -f $(DESTDIR)$(tooldir)/$$file || exit 1; done
	rm -rf $(DESTDIR)$(webroot)/$(WEBNAME)/
	for file in $(MEDIA); do rm -rf $(DESTDIR)$(webroot)/$$file || exit 1; done

clean:
	find -name *.pyc -print0 | xargs -0 rm -f
	for file in $(TEMPLATES); do rm -f $$file; done

distclean: clean
	find -name \*~ -print0 | xargs -0 rm -f
	rm -f Makefile

