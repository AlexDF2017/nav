#!/usr/bin/env bash
####################
#
# This file is part of Network Administration Visualized.
# This script controls start/stop/status of the NAV ipdevpoll daemon
#
# Copyright (C) 2006-2011 UNINETT AS
#
####################
initdir=@initdir@
bindir=@bindir@
user=@nav_user@
IPDEVPOLLD=${bindir}/ipdevpolld

# Source function library.
. ${initdir}/functions

[ -x $IPDEVPOLLD ] || exit 2

# Special case of kill that attempts a graceful shutdown, then waits X seconds
# for the process to disappear before dealing out some tough SIGKILL love.
# This because busy ipdevpoll threads can cause shutdown to take a very long
# time.
kill() {
    pid=$1
    timeout=10 # wait max 10 seconds
    if /bin/kill $pid; then
        counter=0
        while test "$counter" -lt "$timeout" && checkpid $pid 2>&1; do
            sleep 1
            counter=$((counter+1))
        done
        checkpid $pid && /bin/kill -9 $pid || true
    else
        return 1
    fi
}

case "$1" in
	start)
		# Start daemon
		echo -n "Starting ipdevpoll: "
		daemon "su - ${user} -c $IPDEVPOLLD"
		rc=$?
		echo
		exit $rc
		;;
	stop)
		# Stop daemon.
		echo -n "Shutting down ipdevpoll: "
		if killproc ipdevpolld; then
		    echo
		    exit 0
		else
		    echo
		    exit 1
		fi
        	;;
	restart)
		$0 stop
		$0 start
		;;
	status)
	        status ipdevpolld
		exit $?
		;;
	*)
		echo "Usage: $0 {start|stop|restart|status}"
		exit 1
esac

exit 0

